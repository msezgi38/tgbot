;=============================================================================
; Dialplan Configuration for Press-1 IVR Bot
;=============================================================================
; This dialplan handles:
; 1. Outbound calls through MagnusBilling trunk
; 2. IVR playback with DTMF detection
; 3. Webhook notifications back to Python bot
;=============================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

;-----------------------------------------------------------------------------
; Context: press-one-ivr
; Entry point for all bot-originated calls
;-----------------------------------------------------------------------------
[press-one-ivr]
; Priority 1: Answer and wait briefly for audio path to establish
exten => _X.,1,NoOp(=== Press-1 IVR Call Started ===)
 same => n,NoOp(CallID: ${CHANNEL(uniqueid)})
 same => n,NoOp(Destination: ${EXTEN})
 same => n,NoOp(CallerID: ${CALLERID(num)})
 same => n,Answer()
 same => n,Wait(0.5)

; Priority 2: Set channel variables for tracking
 same => n,Set(CALL_ID=${CHANNEL(uniqueid)})
 same => n,Set(DESTINATION=${EXTEN})
 same => n,Set(DTMF_PRESSED=0)

; Priority 3: Play IVR message
 same => n,NoOp(Playing IVR audio)
 same => n,Playback(custom/press_one_ivr)   ; Plays press_one_ivr.wav
 
; Priority 4: Wait for DTMF digit with timeout
 same => n,NoOp(Waiting for DTMF input - 10 second timeout)
 same => n,Read(DTMF_INPUT,beep,1,,,10)     ; Wait max 10 seconds for 1 digit

; Priority 5: Check if user pressed '1'
 same => n,GotoIf($["${DTMF_INPUT}" = "1"]?pressed_one:no_response)

; User pressed '1' - Success scenario
 same => n(pressed_one),NoOp(User pressed 1 - SUCCESS!)
 same => n,Set(DTMF_PRESSED=1)
 same => n,Playback(thank-you)
 same => n,Goto(send_webhook)

; No response or wrong digit
 same => n(no_response),NoOp(No valid response received: ${DTMF_INPUT})
 same => n,Set(DTMF_PRESSED=0)
 same => n,Goto(send_webhook)

; Send webhook to Python bot
 same => n(send_webhook),NoOp(Sending webhook notification)
 same => n,Set(CURL_RESULT=${CURL(http://localhost:8000/dtmf_webhook,call_id=${CALL_ID}&destination=${DESTINATION}&dtmf_pressed=${DTMF_PRESSED}&callerid=${CALLERID(num)})})
 same => n,NoOp(Webhook response: ${CURL_RESULT})

; Cleanup and hangup
 same => n,NoOp(Call completed - Hanging up)
 same => n,Hangup()

; Handle hangup during call
 same => n(call_failed),NoOp(Call failed or hungup early)
 same => n,Hangup()

;-----------------------------------------------------------------------------
; Context: from-magnus
; Handles incoming calls from MagnusBilling (if any)
;-----------------------------------------------------------------------------
[from-magnus]
exten => _X.,1,NoOp(Incoming call from MagnusBilling: ${CALLERID(all)})
 same => n,NoOp(This trunk is outbound-only - rejecting)
 same => n,Busy()
 same => n,Hangup()

;-----------------------------------------------------------------------------
; Hangup Handler - Catches unexpected disconnections
;-----------------------------------------------------------------------------
[hangup-handler]
exten => h,1,NoOp(=== Call Ended ===)
 same => n,NoOp(Hangup Cause: ${HANGUPCAUSE})
 same => n,NoOp(Call Duration: ${CDR(duration)} seconds)
 same => n,NoOp(Billable Duration: ${CDR(billsec)} seconds)
 ; Send final webhook if call ended unexpectedly
 same => n,GotoIf($["${DTMF_PRESSED}" = ""]?send_hangup_webhook:done)
 same => n(send_hangup_webhook),Set(CURL_RESULT=${CURL(http://localhost:8000/dtmf_webhook,call_id=${CALL_ID}&destination=${DESTINATION}&dtmf_pressed=0&hangup_cause=${HANGUPCAUSE}&duration=${CDR(billsec)})})
 same => n(done),Return()

;-----------------------------------------------------------------------------
; Configuration Notes:
;-----------------------------------------------------------------------------
; 1. Audio file 'custom/press_one_ivr.wav' must exist in:
;    /var/lib/asterisk/sounds/custom/press_one_ivr.wav
; 2. Webhook endpoint runs on localhost:8000 (Python FastAPI server)
; 3. Adjust timeout in Read() command if needed (currently 10 seconds)
; 4. CURL module must be loaded in modules.conf
; 5. Test with: asterisk -rx "dialplan show press-one-ivr"
;=============================================================================
