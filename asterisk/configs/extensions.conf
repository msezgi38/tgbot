;=============================================================================
; Dialplan Configuration for Press-1 IVR Bot
;=============================================================================
; This dialplan handles:
; 1. Outbound calls through per-user PJSIP trunks
; 2. IVR playback with DTMF detection
; 3. Webhook notifications back to Python bot
;=============================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

;-----------------------------------------------------------------------------
; Context: press-one-ivr
; Entry point for all bot-originated calls
;-----------------------------------------------------------------------------
[press-one-ivr]
; Priority 1: Answer and wait briefly for audio path to establish
exten => _X.,1,NoOp(=== Press-1 IVR Call Started ===)
 same => n,NoOp(CallID: ${CHANNEL(uniqueid)})
 same => n,NoOp(Destination: ${EXTEN})
 same => n,NoOp(CallerID: ${CALLERID(num)})
 same => n,NoOp(CampaignID: ${CAMPAIGN_ID})
 same => n,NoOp(CampaignDataID: ${CAMPAIGN_DATA_ID})
 same => n,NoOp(VoiceFile: ${VOICE_FILE})
 same => n,Answer()
 same => n,Wait(1)

; Priority 2: Set channel variables for tracking
 same => n,Set(CALL_ID=${CHANNEL(uniqueid)})
 same => n,Set(DESTINATION=${EXTEN})
 same => n,Set(DTMF_PRESSED=0)
 same => n,Set(CALL_START=${EPOCH})

; Priority 3: Play IVR message (user's uploaded voice or default)
 same => n,NoOp(Playing IVR audio: ${VOICE_FILE})
 same => n,GotoIf($["${VOICE_FILE}" != ""]?play_custom:play_default)

 same => n(play_custom),Playback(${VOICE_FILE})
 same => n,Goto(wait_dtmf)

 same => n(play_default),Playback(custom/press_one_ivr)
 same => n,Goto(wait_dtmf)

; Priority 4: Wait for DTMF digit with timeout
 same => n(wait_dtmf),NoOp(Waiting for DTMF input - 10 second timeout)
 same => n,Read(DTMF_INPUT,beep,1,,,10)

; Priority 5: Check if user pressed '1'
 same => n,Set(CALL_DURATION=$[${EPOCH}-${CALL_START}])
 same => n,GotoIf($["${DTMF_INPUT}" = "1"]?pressed_one:no_response)

; User pressed '1' - Success scenario
 same => n(pressed_one),NoOp(User pressed 1 - SUCCESS!)
 same => n,Set(DTMF_PRESSED=1)
 same => n,Playback(thank-you)
 same => n,Goto(send_webhook)

; No response or wrong digit
 same => n(no_response),NoOp(No valid response received: ${DTMF_INPUT})
 same => n,Set(DTMF_PRESSED=0)
 same => n,Goto(send_webhook)

; Send webhook to Python bot (POST JSON to FastAPI)
 same => n(send_webhook),NoOp(Sending webhook notification)
 same => n,Set(HASH(headers,Content-Type)=application/json)
 same => n,Set(CURL_RESULT=${CURL(http://localhost:8000/webhook/dtmf,{"call_id":"${CALL_ID}","digit":"${DTMF_INPUT}","duration":${CALL_DURATION},"campaign_id":"${CAMPAIGN_ID}","campaign_data_id":"${CAMPAIGN_DATA_ID}"})})
 same => n,NoOp(Webhook response: ${CURL_RESULT})

; Cleanup and hangup
 same => n,NoOp(Call completed - Hanging up)
 same => n,Hangup()

; Handle hangup during call
 same => n(call_failed),NoOp(Call failed or hungup early)
 same => n,Hangup()

;-----------------------------------------------------------------------------
; Hangup Handler - Catches unexpected disconnections
;-----------------------------------------------------------------------------
[hangup-handler]
exten => h,1,NoOp(=== Call Ended ===)
 same => n,NoOp(Hangup Cause: ${HANGUPCAUSE})
 same => n,NoOp(Call Duration: ${CDR(duration)} seconds)
 same => n,NoOp(Billable Duration: ${CDR(billsec)} seconds)
 ; Send hangup webhook if DTMF was never processed
 same => n,GotoIf($["${DTMF_PRESSED}" = ""]?send_hangup_webhook:done)
 same => n(send_hangup_webhook),Set(CURL_RESULT=${CURL(http://localhost:8000/webhook/hangup,{"call_id":"${CALL_ID}","duration":${CDR(billsec)},"hangup_cause":"${HANGUPCAUSE}","campaign_id":"${CAMPAIGN_ID}","campaign_data_id":"${CAMPAIGN_DATA_ID}"})})
 same => n(done),Return()

;-----------------------------------------------------------------------------
; Context: from-magnus
; Handles incoming calls from MagnusBilling (if any)
;-----------------------------------------------------------------------------
[from-magnus]
exten => _X.,1,NoOp(Incoming call from MagnusBilling: ${CALLERID(all)})
 same => n,NoOp(This trunk is outbound-only - rejecting)
 same => n,Busy()
 same => n,Hangup()

;-----------------------------------------------------------------------------
; Configuration Notes:
;-----------------------------------------------------------------------------
; 1. Default audio file: /var/lib/asterisk/sounds/custom/press_one_ivr.wav
; 2. User voice files: /opt/tgbot/voices/{user_id}/{filename}
;    VOICE_FILE variable should be full path without extension
; 3. Webhook endpoint runs on localhost:8000 (Python FastAPI server)
; 4. CURL module must be loaded (res_curl in modules.conf)
; 5. Test with: asterisk -rx "dialplan show press-one-ivr"
; 6. Channel variables set by campaign_worker:
;    CAMPAIGN_ID, CAMPAIGN_DATA_ID, VOICE_FILE
;=============================================================================
